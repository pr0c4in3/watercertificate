<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
 
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>管理证书</title>
  <link rel="stylesheet" href="static/css/index.css">

<style>
    .logout>button{
        background-color: rgb(118, 136, 215);
        font-size: 20px;
    }
    .logout{
        border: 1px white solid;
        display: inline-block;
        position: absolute;
        right: 20px;
    }
    .pagination {
        text-align: center;
        margin-top: 20px;
    }
    .pagination button {
        margin: 0 5px;
    }
</style>
<script>
let currentPage = 1;
const itemsPerPage = 10; // 每页显示的条目数

async function searchCertificates() {
    const searchQuery = document.getElementById('search-input').value;
    const loggedInUser = localStorage.getItem('loggedInUser');
    console.log('搜索查询:', searchQuery);
    console.log('当前用户:', loggedInUser);

    // 假设这里调用后台的 JSON 接口
    const response = await fetch(`/showlist`);
    const certificates = await response.json();

    displayCertificates(certificates);
}

function displayCertificates(certificates) {
    const tableBody = document.querySelector('#certificate-table tbody');
    tableBody.innerHTML = ''; // 清空表格内容

    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const paginatedCertificates = certificates.slice(start, end);

    paginatedCertificates.forEach(certificate => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${certificate.id}</td>
            <td>${certificate.image_name}</td>
            <td>${certificate.watermark}</td>
            <td><button onclick="previewImage('${certificate.image_name}')">预览</button></td>
            <td><button onclick="confirmDelete('${certificate.image_name}')">删除</button></td>
        `;
        tableBody.appendChild(row);
    });

    updatePagination(certificates.length);
}

function updatePagination(totalItems) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const paginationDiv = document.getElementById('pagination');
    paginationDiv.innerHTML = '';

    const prevButton = document.createElement('button');
    prevButton.textContent = '上一页';
    prevButton.disabled = currentPage === 1;
    prevButton.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            searchCertificates();
        }
    };
    paginationDiv.appendChild(prevButton);

    const pageInfo = document.createElement('span');
    pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
    paginationDiv.appendChild(pageInfo);

    const nextButton = document.createElement('button');
    nextButton.textContent = '下一页';
    nextButton.disabled = currentPage === totalPages;
    nextButton.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            searchCertificates();
        }
    };
    paginationDiv.appendChild(nextButton);
}

function previewImage(imageName) {
    var formData = new FormData();
    formData.append('image_name', imageName);

    fetch('/pic', {
        method: 'POST',
        body: formData
    }).then(response => {
    if (response.ok) {
        // 假设Flask端点处理POST请求后重定向到'/success_page'
        window.location.href = '/pic1'; // 重定向到新页面
    }
    // ...
    })
    // 处理其他情况（例如显示错误消息）
    .catch(error => {
    // 处理网络错误或其他问题
    console.error('There was a problem with the fetch operation:', error);
    });
    // window.open(`/pic?image_name=${imageName}`, '_blank');
}

function confirmDelete(imageName) {
    if (confirm("确定要删除这张图片吗？")) {
        var formData = new FormData();
        formData.append('image_name', imageName);
        fetch('/del_pic', {
            method: 'POST',
            body: formData
            // method: 'POST',
            // headers: {
            //     'Content-Type': 'application/json'
            // },
            // body: JSON.stringify({ image_name: imageName })
        }).then(response => {
            if (response.ok) {
                alert('图片已删除');
                searchCertificates(); // 刷新表格
            } else {
                alert('删除失败');
            }
        });
    }
}

</script>
</head>
 
<body>
    <div class="logout">
        <span style="color: white;font-weight: bolder; margin: 0;">欢迎你&nbsp;{{username}}</span>
        <button onclick="cclick()">Logout</button>
        <script>
            function cclick(){
                alert("登出当前用户");
                window.location.href = 'login';
            }
        </script>
    </div>

  <div class='card-holder'>
    <div class='card-wrapper'>
        <a href=''>
            <div class='card bg-01'>
                <span class='card-content'>添加水印</span>
            </div>
        </a>
    </div>
    <div class='card-wrapper'>
        <a href='/watermark_trace'>
            <div class='card bg-02'>
                <span class='card-content'>水印提取</span>
            </div>
        </a>
    </div>
    <div class='card-wrapper'>
        <a href='/management'>
            <div class='card bg-03'>
                <span class='card-content'>证书管理</span>
            </div>
        </a>
    </div>
  </div>
  <div class="box">
    <div class="header">
        <h1>证书管理</h1>
        <div class="user-info">
            <span id="logged-in-user"></span>
        </div>
    </div>
    <div class="search-bar">
        <input type="text" id="search-input" placeholder="搜索证书...">
        <button id="search-button" onclick="searchCertificates()">搜索</button>
    </div>
    <div id="certificate-list">
        <table id="certificate-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>图片名称</th>
                    <th>水印</th>
                    <th>预览</th>
                    <th>删除</th>
                </tr>
            </thead>
            <tbody>
                <!-- 证书列表将在这里动态生成 -->
            </tbody>
        </table>
    </div>
    <div id="pagination" class="pagination">
        <!-- 分页按钮和页码将在这里动态生成 -->
    </div>
  </div>

  <div class="msg_box">
    <div class="msg_btn_box">
      CopyRight 2024, by 天才 team All Rights Reserved.
    </div>
  </div>            <!--版权声明 -->
</body>
 
</html>
